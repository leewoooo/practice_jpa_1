변경 감지 및 merge
===

## 준영속 Entity

준영속 엔티티란 영속성 컨텍스트가 더 이상 관리 하지 않는 엔티티를 이야기한다.

새로운 엔티티 객체를 생성했더라도 기존 식별자를 가지고 있으면 준영속 엔티티라고 할 수 있다.

영속성 컨테스트가 관리하는 엔티티는 값이 변경되면 commit되는 시점에서 dirty checking(변경 감지)를 하여 TX(트랜잭션)안에서
commit되는 시점에 Update query가 DB로 가게 된다.

## 그렇다면 준영속 엔티티를 수정하는 방법은 뭐가 있을까?

1. 변경 감지 기능 사용하기
2. 병합(merge)사용하기

### 변경 감지 기능 사용하기 (지향)

준영속 엔티티는 변경감지가 적용하지 않아 상태값을 아무리 변경해도 DB의 값이 변경되지 않는다.

TX안에서 식별자를 이용하여 영속성 엔티티를 가져온 후 -> 준영속 엔티티를 이용하여 영속성 엔티티의 상태를 변경한다. (이 후 save 로직을 추가적으로 호출할 필요 없다.)

### merge (지양)

준영속 엔티티를 영속성 엔티티로 변경해준다. EntityManager가 제공하는 API이다.

내부적으로 아래와 같은 순서로 작동한다. 

1. 준영속 엔티티의 식별자를 가지고 1차 캐시에서 값을 찾는다.
2. 없으면 DB에서 조회하여 1차 캐시에 올려 놓는다.
3. 준영속 엔티티와 식별자로 찾은 엔티티 병합하기
4. 병합된 엔티티를 영속성 컨텍스트에서 관리

하지만 여기서 주의해야 할 점이 있다. **변경 감지는 선택적으로 변경할 값을 지정할 수 있지만 merge의 경우 다르다.**

merge의 경우 **엔티티의 모든 값을 준영속 엔티티의 값으로 덮어쓴다. 그렇기 때문에 만약 준영속 엔티티에 null값이 들어 있다면 그대로 DB에 null값이 들어갈 수 있다.**

그렇기 때문에 merge를 지양하고 **변경 감지를 사용하자.** merge가 완료되면 준영속 엔티티가 영속성 컨텍스트에 관리되는 것이 아니라
**준영속 엔티티와 조회하여 가져온 엔티티가 병합된 결과물이 영속성 컨텍스트에서 관리된다.**

